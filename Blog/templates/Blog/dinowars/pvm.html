{% extends 'Blog/layout/base.html' %}
{% load static %}
{% load dino_tags %}

{% block content %}
{% csrf_token %}
<div class="pvm-container">
    <div class="user-info">
        <h2>Infos de la Run</h2>
        {% if run_info %}
            <div class="stats">
                <p id="terrain" data-desc="{{terrain.description}}" class="has-tooltip">Terrain: {{ terrain.name }}<i class="fi fi-rs-info"></i>
                    <span class="tooltip">{{terrain.description}}</span>
                </p>
                <p>---------------------</p>
                <p>Niveau: {{ run_info.level }}</p>
                <p>Vies restantes: 
                    {% for i in life_counter %}
                        <i class="fi fi-ss-heart"></i>
                    {% endfor %}
                </p>
                <p>---------------------</p>
                <p>Points de statistiques: <span id="main-stat-points-counter">{{ run_info.stat_points }}</span></p>
            </div>
        {% else %}
            <div class="stats">
                <p>No active run</p>
                <p>Start a new run to begin your adventure!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="user-actions-section">
        <button class="action-btn back-btn">Retour au PvP</button>
        <button class="action-btn next-fight-btn">Combattre</button>
        <button class="action-btn fight-history-btn">Historique des combats</button>
    </div>

    <div class="run-dinos-section">
        <h2>Dinosaures de l'équipe</h2>
        {% if run_info %}
            <div class="dinos-grid" id="dinosGrid">
                {% for dino in run_dinos %}
                    <div class="dino-card" data-name="{{ dino.dino.name }}" data-dino-id="{{ dino.id }}">
                        <h3>{{ dino.dino.name }}</h3>
                        <div class="small-stats">
                            <p><i class="fi fi-ss-heart"></i> {{ dino.hp }}</p>
                            <p><i class="fi fi-ss-sword-alt"></i> {{ dino.atk }}</p>
                            <p><i class="fi fi-ss-shield"></i> {{ dino.defense }}</p>
                            <p><i class="fi fi-ss-bolt"></i> {{ dino.spd }}</p>
                            <p><i class="fi fi-ss-location-crosshairs"></i> {{ dino.crit }}</p>
                            <p><i class="fi fi-ss-burst"></i> {{ dino.crit_dmg }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>Pas de run actif. Commencez un nouveau run pour continuer.</p>
        {% endif %}
    </div>

    <div class="next-fight-dinos-section">
        <h2>Prochain combat</h2>
        {% if run_info %}
            <div class="dinos-grid" id="dinosGrid">
                {% for dino in next_fight_dinos %}
                    <div class="dino-card enemy-card" data-name="{{ dino.dino.name }}" data-dino-id="{{ dino.id }}" data-enemy="true">
                        <h3>{{ dino.dino.name }}</h3>
                        <div class="small-stats">
                            <p><i class="fi fi-ss-heart"></i> {{ dino.hp }}</p>
                            <p><i class="fi fi-ss-sword-alt"></i> {{ dino.atk }}</p>
                            <p><i class="fi fi-ss-shield"></i> {{ dino.defense }}</p>
                            <p><i class="fi fi-ss-bolt"></i> {{ dino.spd }}</p>
                            <p><i class="fi fi-ss-location-crosshairs"></i> {{ dino.crit }}</p>
                            <p><i class="fi fi-ss-burst"></i> {{ dino.crit_dmg }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>Pas de run actif. Commencez un nouveau run pour continuer.</p>
        {% endif %}
    </div>

    <div id="dinoDetailPopup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-popup" onclick="closeDinoDetailPopup()">&times;</span>
            <div id="dinoDetailContent"></div>
        </div>
    </div>

    <div class="next-abilities-section">
        <h2>Choisir une nouvelle capacité</h2>
        <div id="next-abilities-container">
            {% if next_abilities %}
                {% for ability in next_abilities %}
                    <div class="ability-card {% if ability.is_selected %}selected-ability{% elif ability.is_discarded %}discarded-ability{% else %}selectable-ability{% endif %}" 
                         data-ability-id="{{ ability.id }}" 
                         data-selected="{{ ability.is_selected|yesno:"true,false" }}"
                         data-discarded="{{ ability.is_discarded|yesno:"true,false" }}">
                        <h3>{{ ability.ability.name }}</h3>
                        <p>{{ ability.ability.description }}</p>
                        {% if not ability.is_selected and not ability.is_discarded %}
                            <span class="select-prompt">Cliquez pour sélectionner</span>
                        {% elif ability.is_selected %}
                            <span class="selected-prompt">Capacité sélectionnée</span>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>Aucune nouvelle capacité débloquée pour l'instant.</p>
            {% endif %}
        </div>
    </div>

    <div class="run-abilities-section">
        <h2>Capacités obtenues</h2>
        <div id="abilities-container">
            {% if run_abilities %}
                {% for ability in run_abilities %}
                    <div class="ability-card">
                        <h3>{{ ability.ability.name }}</h3>
                        <p>{{ ability.ability.description }}</p>
                        {% if ability.dino %}     
                            <p class="ability-dino-info">Assignée à: {{ ability.dino.dino.name }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>Aucune capacité obtenue pour l'instant.</p>
            {% endif %}
        </div>
    </div>

    <div id="statAllocationPopup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-popup" onclick="closeStatAllocationPopup()">&times;</span>
            <div id="statAllocationContent"></div>
        </div>
    </div>

    <div id="dinoSelectionPopup" class="popup-overlay">
        <div class="popup-content">
            <div id="dinoSelectionContent">
                <h2>Sélectionner un dinosaure pour cette capacité</h2>
                <p class="selection-instruction">Cette capacité doit être assignée à un dinosaure spécifique.</p>
                <div class="dinos-selection-grid" id="dinosSelectionGrid">
                    {% if run_dinos %}
                        {% for dino in run_dinos %}
                            <div class="dino-card selectable-dino" data-dino-id="{{ dino.id }}">
                                <h3>{{ dino.dino.name }}</h3>
                                <div class="small-stats">
                                    <p><i class="fi fi-ss-heart"></i> {{ dino.hp }}</p>
                                    <p><i class="fi fi-ss-sword-alt"></i> {{ dino.atk }}</p>
                                    <p><i class="fi fi-ss-shield"></i> {{ dino.defense }}</p>
                                    <p><i class="fi fi-ss-bolt"></i> {{ dino.spd }}</p>
                                    <p><i class="fi fi-ss-location-crosshairs"></i> {{ dino.crit }}</p>
                                    <p><i class="fi fi-ss-burst"></i> {{ dino.crit_dmg }}</p>
                                </div>
                                <span class="select-prompt">Cliquez pour sélectionner</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>Aucun dinosaure disponible.</p>
                    {% endif %}
                </div>
                <input type="hidden" id="currentAbilityId" value="">
            </div>
        </div>
    </div>

    <div id="fightHistoryPopup" class="popup-overlay">
        <div class="popup-content">
            <span class="close-popup" onclick="closeFightHistoryPopup()">&times;</span>
            <div id="fightHistoryContent">
                <h2>Historique des combats de la run</h2>
                <p class="loading-message">Chargement...</p>
                <div id="fightsList" class="fights-list"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'Blog/dinowars/css/pvm.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-straight/css/uicons-regular-straight.css'>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'>
{% endblock %}

{% block extra_js %}
<script src="{% static 'Blog/dinowars/js/pvm.js' %}"></script>
{% endblock %}
